
### 1. Мотивация

Мониторинг критичен для системы, т.к. позволяет:

- Снижать время реакции на инциденты (например, потеря заказов, задержки MES).

- Видеть и анализировать поведение пользователей и API-партнёров.

- Предсказывать перегрузки и масштабировать проактивно.

- Уведомлять DevOps и бизнес при аномалиях (например, 500 ошибки, рост задержек).

- Оценивать SLA: какие заказы обрабатываются с опозданием?

##
### 2. Выбор подхода к мониторингу
- Для API и серверов — используем RED-модель:

    - Rate: количество запросов.

    - Errors: ошибки (5xx).

    - Duration: время ответа.

- Для RabbitMQ и внутренних процессов — USE-модель:

    - Utilization: нагрузка.

    - Saturation: насыщенность (сколько сообщений в очереди).

    - Errors: сбои доставки сообщений.

- Для пользовательской части (MES UI) — Четыре золотых сигнала:

    - Latency, Traffic, Errors, Saturation — особенно важен latency в MES UI.

##
### 3. Метрики и лейблы

#### 1. API

| Метрика          | Зачем                    | Лейблы                             |
| ---------------- | ------------------------ | ---------------------------------- |
| `request_rps`    | отслеживать нагрузку     | `service`, `endpoint`, `user_type` |
| `http_5xx_count` | сигнализирует об ошибках | `service`, `code`                  |
| `http_latency`   | выявлять узкие места     | `service`, `endpoint`              |


#### 2. RabbitMQ

| Метрика              | Зачем                  | Лейблы                 |
| -------------------- | ---------------------- | ---------------------- |
| `messages_in_flight` | определить перегрузки  | `queue`, `routing_key` |
| `dead_letter_count`  | выявить потерю заказов | `queue`                |


#### 3. Базы данных

| Метрика           | Зачем                        | Лейблы            |
| ----------------- | ---------------------------- | ----------------- |
| `db_connections`  | показывает перегрузку        | `db_name`, `role` |
| `db_memory_usage` | контроль ресурсов            | `db_name`         |
| `db_size`         | планирование масштабирования | `db_name`         |


#### 4. MES-дашборд

| Метрика                         | Зачем                       | Лейблы              |
| ------------------------------- | --------------------------- | ------------------- |
| `mes_ui_latency_dashboard_load` | влияет на работу операторов | `page`, `user_role` |
| `orders_count_by_status`        | насыщенность MES            | `status`            |

##
### 4. План действий
1. Развернуть Prometheus + Grafana.

2. Настроить экспортеры:

    - node_exporter, rabbitmq_exporter, postgres_exporter, s3_exporter.

    - для .NET использовать OpenTelemetry SDK + exporter.

3. Настроить алерты в Grafana:

    - RabbitMQ DLQ > 0 → алерт.

    - HTTP 500 > 1% → алерт.
    - latency > 2s → алерт.
4. Создать дешборды:
    - API health (Shop, CRM, MES).
    - RabbitMQ queues.
    - MES UI performance.
5. Уведомления: интеграция Grafana Alerting с Slack/Telegram/email.

##
### 5. Пороговые значения насыщенности (доп. задание)

| Метрика                     | Порог          | Действие при превышении         |
| --------------------------- | -------------- | ------------------------------- |
| `http_latency > 2s`         | > 10% запросов | Алерт DevOps, тикет             |
| `messages_in_flight > 1000` | > 2 мин        | Добавить воркеров, тикет        |
| `dead_letter_count > 0`                   | мгновенно      | Срочный тикет                   |
| `CPU > 80%` на API          | > 5 мин        | Масштабировать инстанс          |
| `mes_ui_latency > 3s`       | > 10% загрузок | Тикет, кеширование, оптимизация |


