### 1. Анализ

В текущей архитектуре заказ может "зависнуть" на любом этапе — особенно между CRM, MES и очередью RabbitMQ. Пользователь не знает, на каком этапе он застрял
#### 1. Системы, подлежащие трейсингу
#### Критические зоны:
- Shop API → создание заказа, загрузка 3D модели.
- CRM API → подтверждение заказа, перевод статуса.
- MES API → расчёт стоимости, начало/завершение производства.
#### Потенциальные точки отказа:
- MES API - задержка в расчётах.
- Несоответствие статусов в CRM и MES.

#### Что включить в трэйсинг (данные)

| Данные    | Пример                                                         |
| --------- | -------------------------------------------------------------- |
| Trace ID  | `abcd1234` (единый ID во всех системах)                        |
| Order ID  | `ORD-5678`                                                     |
| User ID   | `UUID клиента`                                                 |
| Событие   | `order_submitted`, `price_calculated`, `manufacturing_started` |
| Timestamp | Время события                                                  |
| Компонент | MES API, CRM API и т.п.                                        |
| Ошибки    | exception message, stack trace (если есть)                     |



##
### 2. Мотивация

Последствия отсутствия трассировки:

- Увеличивает время расследования инцидентов.
- Приводит к потере заказов.
- Снижает доверие клиентов и партнёров.
- Усложняет масштабирование и оптимизацию.

Трейсинг даст:

- Полную прозрачность прохождения заказа от создания до отгрузки.
- Возможность видеть и алертить залипания.
- Снижение времени диагностики с часов до минут.

##
### 4. Предлагаемое решение
#### Архитектурное решение:
Внедрение OpenTelemetry SDK во все бэкенд-сервисы:
- Java (Spring Boot): через opentelemetry-javaagent или SDK.

- .NET (MES): OpenTelemetry .NET SDK.

Сбор и визуализация: Jaeger + Jaeger UI

Ссылка на схему: `./jewerly_c4_model.drawio`

##
### Компромиcы
- MES — сторонний код. Не все участки кода могут быть документированы, и внедрение OpenTelemetry может потребовать значительных усилий по изучению логики. Возможно потребуется:
    - Обёртки над основными действиями (например, StartManufacturing(), CalculatePrice()).
    - Интеграция через middleware для ASP.NET Core (если используется).

    Риски:
    - Потенциальное увеличение времени спринта.
    - Возможность неохватить всю бизнес-логику MES без глубокого анализа.

- Jaeger требует развертывания:
    - Collector.
    - Storage backend (Elasticsearch, Kafka, или встроенный badger).
    - Jaeger UI.

    Это может:
    - Увеличить стоимость обслуживания (если хранение будет долгосрочное).
    - Потребовать DevOps-настройку в проде и staging (по схеме sidecar или отдельный сервис).

##
### 6. Меры безопасности

#### Безопасность Jaeger UI
- Доступ ограничен через корпоративную VPN или reverse proxy с базовой аутентификацией.
- Настройка OIDC или SSO через Auth Proxy (например, oauth2-proxy).
- Только сотрудники с ролью support или devops могут заходить.

#### Права и доступ
- Только на чтение для большинства команд (support, QA).
- Полный доступ (удаление, правка конфигураций) — только DevOps.

